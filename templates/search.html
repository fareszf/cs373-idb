{% extends "base.html" %}
{% block head %}
{{ super() }}
{% endblock %}


{% block body %}
<h1 align="center">Search Results for &ldquo;{{query}}&rdquo;</h1>
<div id = "searchresults">    
</div>
<script type="text/babel">

 var queries = "{{query}}";
 var queryArray = queries.split(" ");
 var q = "";
 for (var i = 0; i < queryArray.length; i++) {
     if(i == 0)
        q += queryArray[i];
     else
        q += "+OR+" + queryArray[i];
 };
 var source = "https://api.swiftype.com/api/v1/public/engines/search.json?q=" + q + "&engine_key=8eNhTJLVxxJ7yq815rPc"

 var Table = React.createClass({
        getInitialState: function(){
            return {data: []}
        },
        componentDidMount: function(){
            var self = this;
            $.get(this.props.source, function(result) {
              var d = [];
              d.push(result);
              if (this.isMounted()) {
                this.setState({
                  data: d
                });
              }
            }.bind(this));
        },
        componentDidUpdate: function(){
        },
        render: function()
        {
            if(this.state.data.length > 0)
            {
                var queryArray = this.props.queries;
                var data = this.state.data["0"];
                var recCount = data["record_count"];
                var info = data["info"];
                var infopage = info["page"];
                var records = data["records"];
                var list = records["page"].map(function(d, index){
                    var sections = d["sections"];
                    var highlight = d["highlight"];
                    var h = (highlight["body"]) ? highlight["body"] : highlight["sections"];
                    var bodyArray = h.split(" ");
                    var body = bodyArray.map(function(d, index){
                        if(d.charAt(0) == '<')
                            return (<b><i> {d.substring(4,d.length-5)} </i></b>);
                        else
                                return d + " ";
                    });
                    return (<a href={d["url"]} className="list-group-item">
                            <h4 className="list-group-item-heading">{sections["0"]}</h4>
                            <p className="list-group-item-text">{body}</p>
                          </a>)
                });
                var pagination = [];
                var numpages = infopage["num_pages"];
                var curpage = infopage["current_page"];
                var tooManyPage = false;
                for (var i = curpage; i <= numpages; i++) {
                    if(i < curpage + 4 )
                        pagination.push(<li><a href="#">{i}</a></li>);
                    else
                    {
                        if(i == numpages){
                            if(tooManyPage)
                                pagination.push(<li><a href="">...</a></li>);
                            pagination.push(<li><a href="#">{i}</a></li>);
                        }
                            
                        tooManyPage = true;
                    }
                }
                console.log(pagination.length);
                var prevPage = (curpage != 1) ?  (<li><a href="#">Prev</a></li>) : (<li></li>);
                var nextPage = (curpage != numpages) ?  (<li><a href="#">Next</a></li>) : (<li></li>);
                return (
                    <section>
                        <h4>Showing {recCount} from {infopage["total_result_count"]} results</h4>
                        <div className="list-group">
                          {list}
                        </div>
                        <ul className="pagination pagination-lg" id="pagination-demo">
                          {prevPage}
                          {pagination}
                          {nextPage}
                        </ul>
                    </section>)                     
            }
            else
            {
                return (<section></section>)
            }
        }
     });

    React.render(<Table queries={q} source={source}/>, document.getElementById('searchresults'));

</script>
{% endblock %}
